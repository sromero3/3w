{% extends "app_gestion/base_m1.html" %}
{% load static %}
{% load filtros %} 

{% block title %}
  M1 | Comisiones calculadas
{% endblock %}

{% block styles %} 
{% endblock styles %}

{% block content %}
<main id="main" class="main" style="margin-top: 40px">
  <div class="col-lg-12">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">
          VENDEDOR: {{ xComisionCabecera.vendedor__nombre }}
        </h5>

        <table style="border-collapse: collapse; max-width: 400px; font-family: Arial, sans-serif;">
          <tbody>
            <tr>
              <th style="text-align: left; padding-right: 10px; font-weight: 600">SEMANA:</th>
              <td>{{ xComisionCabecera.periodo__numero_semana }}</td>
            </tr>
            <tr>
              <th style="text-align: left; padding-right: 10px; font-weight: 600">DESDE:</th>
              <td>{{ xComisionCabecera.periodo__desde|date:"D, d/m/Y" }}</td>
            </tr>
            <tr>
              <th style="text-align: left; padding-right: 10px; font-weight: 600">HASTA:</th>
              <td>{{ xComisionCabecera.periodo__hasta|date:"D, d/m/Y" }}</td>
            </tr>
          </tbody>
        </table>

        <div class="row">
          <div class="col-12">
            <h5 style="text-align: center; padding-right: 10px; font-weight: 800">
              COMISIONES EN BOLIVARES
            </h5>
          </div>
        </div>

        <table id="comisiones1" class="table table-hover table-bordered" style="width: 100%">
          <thead>
            <tr>
              <th class="text-center">FECHA DOC.</th>
              <th class="text-center">Nro. DOC.</th>
              <th class="text-center">DIAS VEN.</th>
              <th style="width: 350px" class="text-center">CLIENTE</th>
              <th class="text-center">TASA</th>
              <th class="text-center">BASE IMP.</th>
              <th class="text-center">%</th>
              <th class="text-center">COMISIÓN BS.</th>
            </tr>
          </thead>
          <tbody>
            {% for xComi_bs in xComisiones_bs %}
            <tr>
              <td>{{ xComi_bs.fecha_doc|date:"d/m/y" }}</td>
              <td>{{ xComi_bs.documento }}</td>
              <td class="text-center">{{ xComi_bs.dias_vencidos }}</td>
              <td>{{ xComi_bs.cliente_nombre }}</td>
              <td align="right">{{ xComi_bs.tasa|darFormato }}</td>
              <td align="right">{{ xComi_bs.base_impo|darFormato }}</td>
              <td align="right">{{ xComi_bs.porcentaje }}</td>
              <td align="right">{{ xComi_bs.comision_calculada|darFormato }}</td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr>
              <td colspan="4" class="text-end fw-bold">TOTAL COMISIÓN EN BS:</td>
              <td></td>
              <td id="pt" class="text-end fw-bold"></td>
              <td></td>
              <td class="text-end fw-bold">{{ xComisionCabecera.total_comi_bs|darFormato }}</td>
            </tr>
          </tfoot>
        </table>

        <div class="col-12 pt-3">
          <h5 style="text-align: center; padding-right: 10px; font-weight: 800">
            COMISIONES EN DOLARES
          </h5>
        </div>

        <table id="comisiones2" class="table table-hover table-bordered" style="width: 100%">
          <thead>
            <tr>
              <th class="text-center">FECHA DOC.</th>
              <th class="text-center">Nro. DOC.</th>
              <th class="text-center">DIAS VEN.</th>
              <th style="width: 350px" class="text-center">CLIENTE</th>
              <th class="text-center">TASA</th>
              <th class="text-center">BASE IMP.</th>
              <th class="text-center">%</th>
              <th class="text-center">COMISIÓN BS.</th>
            </tr>
          </thead>
          <tbody>
            {% for xComi_usd in xComisiones_usd %}
            <tr>
              <td>{{ xComi_usd.fecha_doc|date:"d/m/y" }}</td>
              <td>{{ xComi_usd.documento }}</td>
              <td class="text-center">{{ xComi_usd.dias_vencidos }}</td>
              <td>{{ xComi_usd.cliente_nombre }}</td>
              <td align="center">-</td>
              <td align="right">{{ xComi_usd.base_impo|darFormato }}</td>
              <td align="right">{{ xComi_usd.porcentaje }}</td>
              <td align="right">{{ xComi_usd.comision_calculada|darFormato }}</td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr>
              <td colspan="4" class="text-end fw-bold">TOTAL COMISIÓN EN $:</td>
              <td></td>
              <td id="pt2" class="text-end fw-bold"></td>
              <td></td>
              <td class="text-end fw-bold">{{ xComisionCabecera.total_comi_usd|darFormato }}</td>
            </tr>
          </tfoot>
        </table>

        <div class="row justify-content-end">
          <div class="col-auto pt-2">
            {% if xComisionCabecera.vendedor_id == 18 %}
            <button id="boton" class="btn btn-primary" style="opacity: 1; width: auto" onclick="generarPDF_oficina()">
              Generar PDF
            </button>
            {% else %}
            <button id="boton" class="btn btn-primary" style="opacity: 1; width: auto" onclick="generarPDF()">
              Generar PDF
            </button>
            {% endif %}
          </div>
          <span class="text-muted" style="font-size: 0.8em">
            (Procesado: {{ xComisionCabecera.creado|date:"d/m/Y H:i:s" }})
          </span>
        </div>
      </div>
    </div>
  </div>
</main>
{% endblock content %}

{% block Scripts_Adicionales %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<script>
  new DataTable('#comisiones1', {
    footerCallback: function (row, data, start, end, display) {
      const api = this.api();
      
      // Función mejorada para convertir valores
      const toNumber = function(value) {
        if (typeof value === 'number') return value;
        if (typeof value === 'string') {
          // Eliminar puntos de miles y reemplazar coma decimal por punto
          const cleaned = value.replace(/\./g, '').replace(',', '.');
          const num = parseFloat(cleaned);
          return isNaN(num) ? 0 : num;
        }
        return 0;
      };
      
      // Calcular total
      const pageTotal = api
        .column(5, { page: 'current' })
        .data()
        .reduce(function (a, b) {
          return toNumber(a) + toNumber(b);
        }, 0);
      
      let pt = darFormato(pageTotal);
      $('#pt').html('<span style="font-size: 15px">' + pt + '</span>');
    },
    language: {
      "sProcessing": "Procesando...",
      "sLengthMenu": "Mostrar _MENU_ registros",
      "sZeroRecords": "No se encontraron resultados",
      "sEmptyTable": "*** No se encontró información ***",
    },
    bInfo: false,
    ordering: false,
    order: [[1, 'asc']],
    paging: false,
    searching: false,
  });

  new DataTable('#comisiones2', {
    footerCallback: function (row, data, start, end, display) {
      const api = this.api();
      
      // Función mejorada para convertir valores
      const toNumber = function(value) {
        if (typeof value === 'number') return value;
        if (typeof value === 'string') {
          // Eliminar puntos de miles y reemplazar coma decimal por punto
          const cleaned = value.replace(/\./g, '').replace(',', '.');
          const num = parseFloat(cleaned);
          return isNaN(num) ? 0 : num;
        }
        return 0;
      };
      
      // Calcular total
      const pageTotal = api
        .column(5, { page: 'current' })
        .data()
        .reduce(function (a, b) {
          return toNumber(a) + toNumber(b);
        }, 0);
      
      let pt2 = darFormato(pageTotal);
      $('#pt2').html('<span style="font-size: 15px">' + pt2 + '</span>');
    },
    language: {
      "sProcessing": "Procesando...",
      "sLengthMenu": "Mostrar _MENU_ registros",
      "sZeroRecords": "No se encontraron resultados",
      "sEmptyTable": "*** No se encontró información ***",
    },
    bInfo: false,
    ordering: false,
    order: [[1, 'asc']],
    paging: false,
    searching: false,
  });

  function agregarPieDePagina(data) {
    const doc = data.doc;
    const pageHeight = doc.internal.pageSize.height || doc.internal.pageSize.getHeight();
    const pageWidth = doc.internal.pageSize.width || doc.internal.pageSize.getWidth();
    const pageNumber = doc.internal.getCurrentPageInfo().pageNumber;
    const totalPages = doc.internal.getNumberOfPages();

    const titulo = "SISTEMA DE GESTIÓN EMPRESARIAL";
    const tituloWidth = doc.getTextWidth(titulo);
    const tituloX = (pageWidth - tituloWidth) / 2;

    const paginaTexto = `Página ${pageNumber} de ${totalPages}`;
    const paginaX = pageWidth - 14;

    doc.setFontSize(8);
    doc.setTextColor(120);

    doc.text(titulo, tituloX, pageHeight - 5);
    doc.text(paginaTexto, paginaX, pageHeight - 5, { align: 'right' });
  }

  // -------------------------------------------------------- ok PDF General -----------------------------------------------------------
  function generarPDF() {
    const totalBaseBs = document.getElementById('pt')?.innerText || '';
    const totalBaseUsd = document.getElementById('pt2')?.innerText || '';

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const totalPagesExp = "{total_pages_count_string}";
    let y = 10;

    // Título
    doc.setFontSize(14);
    doc.text("Comisiones Semana: ", 14, y);
    const semana = "{{ xComisionCabecera.periodo__numero_semana }}";
    doc.text(`${semana}`, 62, y);
    y += 6;

    // Vendedor y semana
    const vendedor = "{{ xComisionCabecera.vendedor__nombre }}";
    const desde = "{{ xComisionCabecera.periodo__desde|date:'d/m/Y' }}";
    const hasta = "{{ xComisionCabecera.periodo__hasta|date:'d/m/Y' }}";
    doc.setFontSize(10);
    doc.text(`Desde: ${desde}`, 14, y);
    y += 6;
    doc.text(`Hasta: ${hasta}`, 14, y);
    y += 6;
    doc.setFontSize(10);
    doc.text(`Vendedor: ${vendedor}`, 14, y);
    y += 6;

    // Sub título bolívares
    const titulo = "COMISIONES EN BOLÍVARES";
    const textWidth = doc.getTextWidth(titulo);
    const pageWidth = doc.internal.pageSize.getWidth();
    const x = (pageWidth - textWidth) / 2;
    doc.text(titulo, x, y);
    y += 4;

    doc.autoTable({
      startY: y,
      head: [["Fecha Doc.", "Nro. Doc.", "DV.", "Cliente", "Tasa", "Base Imp.", "%", "Comisión BS"]],
      body: [
        {% for x in xComisiones_bs %}
        [
          "{{ x.fecha_doc|date:'d/m/Y' }}",
          "{{ x.documento }}",
          { content: "{{ x.dias_vencidos }}", styles: { halign: 'center' } },
          { content: "{{ x.cliente_nombre }}", styles: { width: '400px' } },
          { content: "{{ x.tasa|darFormato }}", styles: { halign: 'right' } },
          { content: "{{ x.base_impo|darFormato }}", styles: { halign: 'right' } },
          { content: "{{ x.porcentaje|darFormato }}", styles: { halign: 'right' } },
          { content: "{{ x.comision_calculada|darFormato }}", styles: { halign: 'right' } }
        ],
        {% endfor %}
      ],
      styles: { fontSize: 8 },
      theme: 'grid',
      headStyles: { fillColor: [41, 128, 185] },
      didDrawPage: agregarPieDePagina
    });

    // Totales BS
    const tablaActual = doc.lastAutoTable;
    y = tablaActual.finalY + 5;

    doc.setFontSize(9);
    doc.setFont("helvetica", "bold");

    doc.text("TOTALES:", tablaActual.settings.margin.left, y);

    // Calcular posición x dinámica para "Base Imp."
    const columns = tablaActual.columns;
    const marginLeft = tablaActual.settings.margin.left;
    let xBaseImpBs = marginLeft;
    for (let i = 0; i < 5; i++) {
      xBaseImpBs += columns[i].width;
    }
    xBaseImpBs += columns[5].width - 2;

    // Imprimir totalBaseBs
    doc.text(
      totalBaseBs,
      xBaseImpBs,
      y,
      { align: "right" }
    );

    // Imprimir xComisionCabecera.total_comi_bs
    doc.text(
      "{{ xComisionCabecera.total_comi_bs|darFormato }}",
      tablaActual.settings.margin.left + 180,
      y,
      { align: "right" }
    );

    doc.setFont("helvetica", "normal");
    y += 8;

    // Sub título dólares
    doc.setFontSize(10);
    const titulo2 = "COMISIONES EN DOLARES";
    const textWidth2 = doc.getTextWidth(titulo2);
    const pageWidth2 = doc.internal.pageSize.getWidth();
    const x2 = (pageWidth2 - textWidth2) / 2;
    doc.text(titulo2, x2, y);
    y += 4;

    doc.autoTable({
      startY: y,
      head: [["Fecha Doc.", "Nro. Doc.", "DV.", "Cliente", "Tasa", "Base Imp.", "%", "Comisión USD"]],
      body: [
        {% for x in xComisiones_usd %}
        [
          "{{ x.fecha_doc|date:'d/m/Y' }}",
          "{{ x.documento }}",
          { content: "{{ x.dias_vencidos }}", styles: { halign: 'center' } },
          { content: "{{ x.cliente_nombre }}", styles: { width: '400px' } },
          { content: "-", styles: { halign: 'center' } },
          { content: "{{ x.base_impo|darFormato }}", styles: { halign: 'right' } },
          { content: "{{ x.porcentaje|darFormato }}", styles: { halign: 'right' } },
          { content: "{{ x.comision_calculada|darFormato }}", styles: { halign: 'right' } }
        ],
        {% endfor %}
      ],
      styles: { fontSize: 8 },
      theme: 'grid',
      headStyles: { fillColor: [39, 174, 96] },
      didDrawPage: agregarPieDePagina
    });

    y = doc.lastAutoTable.finalY + 5;

    doc.setFontSize(9);
    doc.setFont("helvetica", "bold");

    doc.text("TOTALES:", tablaActual.settings.margin.left, y);

    // Calcular posición x dinámica para "Base Imp." USD
    const columnsUsd = doc.lastAutoTable.columns;
    const marginLeftUsd = doc.lastAutoTable.settings.margin.left;
    let xBaseImpUsd = marginLeftUsd;
    for (let i = 0; i < 5; i++) {
      xBaseImpUsd += columnsUsd[i].width;
    }
    xBaseImpUsd += columnsUsd[5].width - 2;

    // Imprimir totalBaseUsd
    doc.text(
      totalBaseUsd,
      xBaseImpUsd,
      y,
      { align: "right" }
    );

    doc.text(
      "{{ xComisionCabecera.total_comi_usd|darFormato }}",
      tablaActual.settings.margin.left + 180,
      y,
      { align: "right" }
    );

    doc.setFont("helvetica", "normal");
    y += 8;

    y = doc.lastAutoTable.finalY + 20;

    // Firmas
    doc.setFontSize(10);
    doc.text("Procesado por:", 52, y);
    doc.text("Aprobado por:", 137, y);
    y += 15;

    doc.setFontSize(10);
    doc.text("Hibelis Palmar", 65, y - 5, { align: "center" });
    doc.text("Maria Alejandra Mendez", 150, y - 5, { align: "center" });
    doc.line(35, y, 95, y);
    doc.line(120, y, 180, y);

    if (typeof doc.putTotalPages === 'function') {
      doc.putTotalPages(totalPagesExp);
    }

    const nombre_doc = '{{ xComisionCabecera.vendedor__nombre }}' + ' Semana ' + '{{ xComisionCabecera.periodo__numero_semana }}' + '.pdf';
    doc.save(nombre_doc);

    window.location.href = '/comisiones_calculadas/0/Todas/0/';
  }

function generarPDF_oficina() {
  const totalBaseBs = document.getElementById('pt')?.innerText || '';
  const totalBaseUsd = document.getElementById('pt2')?.innerText || '';

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const totalPagesExp = "{total_pages_count_string}";
  let y = 10;

  doc.setFontSize(14);
  doc.text("Comisiones Semana: ", 14, y);
  const semana = "{{ xComisionCabecera.periodo__numero_semana }}";
  doc.text(`${semana}`, 62, y);
  y += 6;

  const vendedor = "{{ xComisionCabecera.vendedor__nombre }}";
  const desde = "{{ xComisionCabecera.periodo__desde|date:'d/m/Y' }}";
  const hasta = "{{ xComisionCabecera.periodo__hasta|date:'d/m/Y' }}";
  doc.setFontSize(10);
  doc.text(`Desde: ${desde}`, 14, y);
  y += 6;
  doc.text(`Hasta: ${hasta}`, 14, y);
  y += 6;
  doc.text(`Vendedor: ${vendedor}`, 14, y);
  y += 6;

  const tituloBs = "COMISIONES EN BOLÍVARES";
  const widthTituloBs = doc.getTextWidth(tituloBs);
  const pageWidth = doc.internal.pageSize.getWidth();
  const xTituloBs = (pageWidth - widthTituloBs) / 2;
  doc.text(tituloBs, xTituloBs, y);
  y += 4;

  doc.autoTable({
    startY: y,
    head: [["Fecha Doc.", "Nro. Doc.", "DV.", "Cliente", "Tasa", "Base Imp.", "%", "Comisión BS"]],
    body: [
      {% for x in xComisiones_bs %}
      [
        "{{ x.fecha_doc|date:'d/m/Y' }}",
        "{{ x.documento }}",
        { content: "{{ x.dias_vencidos }}", styles: { halign: 'center' } },
        { content: "{{ x.cliente_nombre }}", styles: { width: '400px' } },
        { content: "{{ x.tasa|darFormato }}", styles: { halign: 'right' } },
        { content: "{{ x.base_impo|darFormato }}", styles: { halign: 'right' } },
        { content: "{{ x.porcentaje|darFormato }}", styles: { halign: 'right' } },
        { content: "{{ x.comision_calculada|darFormato }}", styles: { halign: 'right' } }
      ],
      {% endfor %}
    ],
    styles: { fontSize: 8 },
    theme: 'grid',
    headStyles: { fillColor: [41, 128, 185] },
    didDrawPage: agregarPieDePagina
  });

  // Totales BS
  const tablaActual = doc.lastAutoTable;
  y = tablaActual.finalY + 5;

  doc.setFontSize(9);
  doc.setFont("helvetica", "bold");

  doc.text("TOTALES:", tablaActual.settings.margin.left, y);

  // ✅ Calcular posición x dinámica para "Base Imp." BS
  const columns = tablaActual.columns;
  const marginLeft = tablaActual.settings.margin.left;
  let xBaseImpBs = marginLeft;
  for (let i = 0; i < 5; i++) {
    xBaseImpBs += columns[i].width;
  }
  xBaseImpBs += columns[5].width - 2;

  // Imprimir totalBaseBs
  doc.text(
    totalBaseBs,
    xBaseImpBs,
    y,
    { align: "right" }
  );

  // Calcular posición para "Comisión BS" (columna 7)
  let xComisionBs = marginLeft;
  for (let i = 0; i < 7; i++) {
    xComisionBs += columns[i].width;
  }
  xComisionBs += columns[7].width - 2;

  doc.text(
    "{{ xComisionCabecera.total_comi_bs|darFormato }}",
    xComisionBs,
    y,
    { align: "right" }
  );

  doc.setFont("helvetica", "normal");
  y += 10;

  // Bloque dólares
  const tituloUsd = "COMISIONES EN DOLARES";
  const widthTituloUsd = doc.getTextWidth(tituloUsd);
  const xTituloUsd = (pageWidth - widthTituloUsd) / 2;
  doc.setFontSize(10);
  doc.text(tituloUsd, xTituloUsd, y);
  y += 4;

  doc.autoTable({
    startY: y,
    head: [["Fecha Doc.", "Nro. Doc.", "DV.", "Cliente", "Tasa", "Base Imp.", "%", "Comisión USD"]],
    body: [
      {% for x in xComisiones_usd %}
      [
        "{{ x.fecha_doc|date:'d/m/Y' }}",
        "{{ x.documento }}",
        { content: "{{ x.dias_vencidos }}", styles: { halign: 'center' } },
        { content: "{{ x.cliente_nombre }}", styles: { width: '400px' } },
        { content: "-", styles: { halign: 'center' } },
        { content: "{{ x.base_impo|darFormato }}", styles: { halign: 'right' } },
        { content: "{{ x.porcentaje|darFormato }}", styles: { halign: 'right' } },
        { content: "{{ x.comision_calculada|darFormato }}", styles: { halign: 'right' } }
      ],
      {% endfor %}
    ],
    styles: { fontSize: 8 },
    theme: 'grid',
    headStyles: { fillColor: [39, 174, 96] },
    didDrawPage: agregarPieDePagina
  });

  // Totales USD
  y = doc.lastAutoTable.finalY + 5;

  doc.setFontSize(9);
  doc.setFont("helvetica", "bold");

  doc.text("TOTALES:", tablaActual.settings.margin.left, y);

  // ✅ Calcular posición x dinámica para "Base Imp." USD
  const columnsUsd = doc.lastAutoTable.columns;
  const marginLeftUsd = doc.lastAutoTable.settings.margin.left;
  let xBaseImpUsd = marginLeftUsd;
  for (let i = 0; i < 5; i++) {
    xBaseImpUsd += columnsUsd[i].width;
  }
  xBaseImpUsd += columnsUsd[5].width - 2;

  // Imprimir totalBaseUsd
  doc.text(
    totalBaseUsd,
    xBaseImpUsd,
    y,
    { align: "right" }
  );

  // Calcular posición para "Comisión USD" (columna 7)
  let xComisionUsd = marginLeftUsd;
  for (let i = 0; i < 7; i++) {
    xComisionUsd += columnsUsd[i].width;
  }
  xComisionUsd += columnsUsd[7].width - 2;

  doc.text(
    "{{ xComisionCabecera.total_comi_usd|darFormato }}",
    xComisionUsd,
    y,
    { align: "right" }
  );

  y += 20;

  doc.setFontSize(10);
  doc.text("Procesado por:", 52, y);
  doc.text("Aprobado por:", 137, y);
  y += 15;

  doc.setFontSize(10);
  doc.text("Hibelis Palmar", 65, y - 5, { align: "center" });
  doc.text("Maria Alejandra Mendez", 150, y - 5, { align: "center" });
  doc.line(35, y, 95, y);
  doc.line(120, y, 180, y);

  if (typeof doc.putTotalPages === 'function') {
    doc.putTotalPages(totalPagesExp);
  }

  const nombre_doc = '{{ xComisionCabecera.vendedor__nombre }} Semana {{ xComisionCabecera.periodo__numero_semana }}.pdf';
  doc.save(nombre_doc);

  window.location.href = '/comisiones_calculadas/0/Todas/0/';
}

</script>
{% endblock Scripts_Adicionales %}