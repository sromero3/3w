{% extends "app_gestion/base_m1.html" %}
{% load static %}
{% load filtros %}
{% block title %}
M1 | Documentos crud
{% endblock %}
{% block styles %}
{% endblock styles %}
{% block content %}
<main id="main" class="main" style="margin-top: 40px">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">{{ xOpcion }} un Documento<a href="{% url 'documentos' 0 1 %}"
                        class="float-end"><i class="bi bi-arrow-return-left" title='Regresar'></i></a></h5>
                <form id="documento_form" action="" method="post" class="row g-3">
                    {% csrf_token %}
                    <!-- ------------------------------------ agregando ------------------------------------- -->
                    {% if xOpcion == 'Agregando' %}
                    <div class="col-6">
                        <span class="titulos">
                            Cliente</span>
                        <select name="cliente" id="cliente" class="form-control d-flex alto" required>
                            <option selected></option>
                            {% for xCliente in xClientes %}
                            <option value={{xCliente.id}}>
                                {{xCliente.nombre}}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-6">
                        <span class="titulos">{{form.numero.label}}</span>
                        {{form.numero}}
                        <input type="text" id="rNum" value="{{rNum}}" hidden>
                    </div>
                    <div class="col-6">
                        <span class="titulos">
                            {{form.fecha.label}}</span><span id="hoy" class="boton-ajustado-a-la-derecha"
                            onclick="get_hoy(id_fecha)">HOY</span>
                        {{form.fecha}}
                    </div>
                    <div class="col-1">
                        <span class="titulos">
                            Dias</span>
                        <select name="credito" id="credito" class="form-control d-flex alto" required
                            onChange="poner_vencimiento()">
                            <option selected></option>
                            {% for xCredito in xCreditos %}
                            <option value={{xCredito.id}} data-dias_credito="{{xCredito.dia}}">
                                {{xCredito.dia}}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-5">
                        <span class="titulos">
                            {{form.vencimiento.label}}</span>
                        {{form.vencimiento}}
                    </div>
                    <div id="div_ref" class="col-md-6">
                        <span class="titulos"> {{form.monto.label}}</span>
                        {{form.monto}}
                    </div>
                    <div class="col-6">
                        <span class="titulos">
                            Iva</span>
                        <select name="iva" id="iva" class="form-control d-flex alto" required>
                            <option selected></option>
                            {% for xIva in xIvas %}
                            <option value={{xIva.id}}>
                                {{xIva.iva}}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12 pb-4">
                        <span class="titulos">
                            {{form.observacion.label}}</span>
                        {{form.observacion}}
                    </div>
                    {% endif %} <!-- fin agregando -->
                    {% csrf_token %}
                    <!-- ------------------------------------ editando ------------------------------------- -->
                    {% if xOpcion == 'Editando' %}
                    <div class="col-6">
                        <span class="titulos">
                            Cliente</span>
                        <select name="cliente" id="cliente" class="form-control d-flex alto" required>
                            <!-- <option selected></option> -->
                            {% for xCliente in xClientes %}
                            <option id={{xCliente.id}} value="{{xCliente.id}}" {% if xCliente.id == rClienteId %} selected
                                {% endif %}>
                                {{xCliente.nombre}}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-6">
                        <span class="titulos">{{form.numero.label}}</span>
                        {{form.numero}}
                        <input type="text" id="rNum" value="{{rNum}}" hidden>
                    </div>
                    <div class="col-6">
                        <span class="titulos">{{form.fecha.label}}</span>
                        {{form.fecha}}
                    </div>
                    <div class="col-6">
                        <span class="titulos">{{form.vencimiento.label}}</span>
                        {{form.vencimiento}}
                    </div>
                    <div class="col-6">
                        <span class="titulos">{{form.monto.label}}</span>
                        {{form.monto}}
                    </div>
                    <div class="col-6">
                        <span class="titulos">
                            Iva</span>
                        <select name="iva" id="iva" class="form-control d-flex alto" required>
                            <!-- <option  selected></option> -->
                            {% for xIva in xIvas %}
                            <option id={{xIva.id}} value="{{xIva.id}}" {% if xIva.id == rIvaId %} selected {% endif %}>
                                {{xIva.iva}}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12 pb-4">
                        <span class="titulos">
                            {{form.observacion.label}}</span>
                        {{form.observacion}}
                    </div>
                    {% endif %} <!-- fin editando -->
                    <!-- Botones -->
                    <div class="text-center">
                        <button type="submit" id="guardar" class="btn btn-primary"
                            onclick="validar(event)">Guardar</button>
                        <button type="button" class="btn btn-secondary"
                            onclick="javascript:window.location='/documentos/0/1'">Regresar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</main><!-- End #main -->
{% if otro %}
<script>
    Swal.fire({
        title: "Su operación ha sido exitosa!",
        //text: "",
        icon: "success"
    });
</script>
{% endif %}
{% endblock content %}

{% block Scripts_Adicionales %}
<script>
    checkPattern("id_monto")
document.getElementById('id_monto').value = darFormato(document.getElementById('id_monto').value)
// formatear entrada
function checkPattern(e) {
    $("#" + e).on({
        "focus": function(event) {
            $(event.target).select()
        },
        "keyup": function(event) {
            $(event.target).val(function(index, value) {
                return value.replace(/\D/g, "")
                    .replace(/([0-9])([0-9]{2})$/, '$1,$2')
                    .replace(/\B(?=(\d{3})+(?!\d)\.?)/g, ".")
            })
        }
    })
} // fin formatear entrada
// validar formulario
function validar(e) {
    const form = document.getElementById('documento_form') // tomo el nombre del formulario
    // si validar
    if (form.checkValidity()) {
        e.preventDefault()
        // validar fechas
        let f = document.getElementById('id_fecha').value
        let v = document.getElementById('id_vencimiento').value
        var fechaf = new Date(f);
        var fechav = new Date(v);
        if (fechaf > fechav) {
            document.getElementById('id_vencimiento').focus();
            Swal.fire({
                position: 'center',
                icon: 'error',
                title: 'la fecha de vencimiento no pude ser menor que la fecha' + ' Verifique...!',
                showConfirmButton: true,
                //timer: 2500
            })
            return
        } // fin validar fechas
        let Var_rNum = document.getElementById('rNum').value
        let Var_numero = document.getElementById('id_numero').value
        console.log("Var_rNum: ", Var_rNum, "-", Var_numero)
        if (Var_rNum != Var_numero) {
            // validar numero
            let existe = false
            let campo = $('#id_numero').val()
            $.ajax({
                url: "{% url 'validar_numero' %}",
                type: 'POST',
                async: false,
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    'campo': campo,
                },
                datatype: 'json',
                success: function(data) {
                    // console.log('RESULTADO', data.status, typeof data.status)
                    existe = data.status
                },
                error: function(xhr, status, error) {}
            })
            if (existe) {
                document.getElementById('id_numero').focus();
                Swal.fire({
                    position: 'center',
                    icon: 'error',
                    title: 'Este numero de Documento ya esta rigistrado' + ' Verifique...!',
                    showConfirmButton: true,
                    //timer: 2500
                })
                return;
            } //validar numero
        } // fin si validar
        // Condirmar
        let c = document.getElementById('cliente').value
        let credito_select = document.getElementById("cliente")
        let c_texto = cliente.options[cliente.selectedIndex].text
        let m = document.getElementById('id_monto').value
        let n = document.getElementById('id_numero').value
        Swal.fire({
            title: '¿ Esta seguro de Guardar ?',
            html: `DOC: ${n}<br>DE: ${c_texto}<br><h1>${m}$</h1> `,
            showDenyButton: true,
            // showCancelButton: true,
            confirmButtonText: "Guardar",
            denyButtonText: `Descartar`
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('documento_form').submit()
            } else {
                return false
            }
        }) // fin Confirmar        
    } // fin de checkValidity()
} // fin validar formulario
function poner_vencimiento() {
    let Fecha = new Date(document.getElementById('id_fecha').value + "T00:00:00")
    if (esFechaValida(Fecha) == false) {
        document.getElementById('id_fecha').focus();
        Swal.fire({
            position: 'center',
            icon: 'error',
            title: 'la fecha no es valida' + ' Verifique...!',
            showConfirmButton: true,
            //timer: 2500
        })
        return
    }
    let v = new Date(document.getElementById('id_vencimiento').value)
    credito_select = document.getElementById('credito');
    d = credito_select.options[credito_select.selectedIndex].dataset.dias_credito
    var sFecha = fecha || (Fecha.getDate() + "/" + (Fecha.getMonth() + 1) + "/" + Fecha.getFullYear());
    var sep = sFecha.indexOf('/') != -1 ? '/' : '-';
    var aFecha = sFecha.split(sep);
    var fecha = aFecha[2] + '/' + aFecha[1] + '/' + aFecha[0];
    fecha = new Date(fecha);
    fecha.setDate(fecha.getDate() + parseInt(d));
    var anno = fecha.getFullYear();
    var mes = fecha.getMonth() + 1;
    var dia = fecha.getDate();
    mes = (mes < 10) ? ("0" + mes) : mes;
    dia = (dia < 10) ? ("0" + dia) : dia;
    var fechaFinal = anno + "-" + mes + "-" + dia;
    document.getElementById('id_vencimiento').value = fechaFinal;
} // fin poner vencimiento
function esFechaValida(fecha) {
    var fechaObj = new Date(fecha);
    return fechaObj instanceof Date && !isNaN(fechaObj);
}
</script>
{% endblock Scripts_Adicionales %}